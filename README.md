# О проекте

Данный репозиторий содержит код бота для телеграм как интерфейс 
взаимодействия с пользователем и consumer осуществляющий первоначальную обработку
видео. Бот решено использовать как канал асинхронного общения с пользователем
и уведомление о состоянии без распухания инфраструктуры.

## Реализованная функциональность

Взаимодействие с пользователем путем сообщений в телеграмм.

Скачивание видео с поэтапной работой:

**Раскадровка видео**

Извлечение всех кадров из оригинального видео файла, выгрузка в s3, передача сообщения
о состоянии в sqs для начала обработки следующим консюмером в pipeline

**Извлечение аудио дорожки из видео**

После извлечения аудио дорожки в формате wav выгружаем файл в s3 и оформляем
задачу с информацией о состоянии в sqs

ML проект находится в отдельном репозитории https://github.com/hack041221/ml-libs

## Особенность проекта

## Основной стек технологий

* golang - основной язык программирования
* terraform - используется для iac, разворачивания приложений в k8s
* gitlab-ci - для автоматизации и ci/cd процессов, доставки кода в prod
* kubernetes - дефакто стандарт оркестрации контейнеров, возможность горизонтального масштабирования
* aws s3 - для замкнутого контура можно использовать любые альтернативы: minio, netapp s3, etc
* aws sqs - можно использовать любые альтернативы: rabbitmq, redis streams, kafka

ML проект лежит в отдельном репозитории https://github.com/hack041221/ml-libs

P.S. - aws в проекте не обязателен и использоваться исключительно в целях ускорения
разработки MVP. Выбор s3 носит рекоммендательный характер и обусловлен распределенной архитектурой.


## Демо

Демо телеграм бот.

```
@hack041221_bot
```

Бот принимает только прямые ссылки на видео файлы. Формат файла не имеет значения.
Плейлисты не поддерживаются, только видео файлы.

Пример файла:
```
https://e6-vod-video.rbc.ru/archive/2021/11/15/1800.folder/telecast_576p.mp4
```

Результат в человеко-читаемом формате (под капотом json на вход / выход):
```
Ratio: -0.04084420204162598
Польша ввела новые санкции против белорусских граждан, которые, по мнению Варшавы, причастны к нелегальной переброске мигрантов на территорию страны.

Ratio: -0.033784665167331696
Президент Белоруссии Александр Лукашенко объявил о введении новых санкций против граждан страны, которые нелегально пересекают белорусско-польскую границу.

Ratio: -0.030976267531514168
Президент Белоруссии Александр Лукашенко заявил, что Белоруссия готова принять беженцев из Польши, если польша не будет препятствовать этому гуманитарному коридору.

Ratio: -0.05981193855404854
Польша и Белоруссия договорились о прекращении огня в приграничных с ними районах. Это решение было принято на фоне обострения ситуации в приграничных районах.

Ratio: -0.03599221631884575
Министр обороны Армении Армен Карапетян освобожден от должности и назначен на должность вице-премьера страны.

Ratio: -0.10484714061021805
Министерство обороны Армении обвинило азербайджанские военные в обстрелах приграничных районов страны. По словам вице-премьера Армении Армена Гаспаряна, азербайджанские военные «начали наступление» на одном из участков границы.

Ratio: -0.09108307957649231
В Алма-Ате построили новую биолабораторию по изучению вирусов, вызывающих тяжёлые и смертельно опасные заболевания.

--------
LOC: армения, азербайджан, европа, алма-ата, литва, варшава, польша, белоруссия, евросоюз, минск

PER: лукашенко, александр лукашенко, армен карапетян, даль грибаускать, армена гаспарян

ORG: министерство оборона
```

---

# СРЕДА ЗАПУСКА

### Установка и разворачивание проекта локально

Перед началом работы требуется создать `.env` файл с следующими `ENV`:

```shell
TELEGRAM_TOKEN=токен телеграм бота полученный от botfather
AWS_ACCESS_KEY=aws access ключ
AWS_BUCKET=aws s3 bucket
AWS_REGION=регион aws
AWS_SECRET_KEY=aws secret ключ
JOB_URL=url адрес sqs очереди
STATE_URL=url адрес sqs очереди
AUDIO_URL=url адрес sqs очереди
FRAME_URL=url адрес sqs очереди
```

Далее требуется собрать docker контейнеры. Сделать это можно вручную или с помощью
Makefile

```
$ make
build-bot           compile telegram bot
build-downloader    compile downloader
run                 docker-compose up
help                show this help
```

выполняем `make run`

### Установка и разворачивание проекта в prod

Для разворачивания проекта в kubernetes используется terraform. Он же выполняет
роль iac. Для сборки проекта в репозитории существует `.gitlab-ci.yml` файл для
ci/cd `gitlab`.

Минимальные технические требования проекта в формате <name> - <cpu> / <ram>:

```
bot - 300m / 256mib
downloader - 1 / 512mib
```

для разворачивания проекта в k8s средствами gitlab-ci или вручную в директории
`.terraform` необходимо описать все значения по файлу `variables.tf` и выполнить
последовательно `terraform plan` и `terraform apply`.

